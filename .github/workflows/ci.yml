name: ci

on:
  workflow_call:

jobs:
  build:
    name: ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x64-main
            os: ubuntu-latest
            shard: main
            build_args: --no-functional-tester
          - name: linux-arm64-main
            os: ubuntu-24.04-arm
            shard: main
            build_args: --no-functional-tester
          - name: macos-arm64-main
            os: macos-latest
            shard: main
            build_args: --no-functional-tester
          - name: linux-x64-asan
            os: ubuntu-latest
            shard: func-asan
            build_args: --sanitizer=asan
          - name: linux-x64-ubsan
            os: ubuntu-latest
            shard: func-ubsan
            build_args: --sanitizer=ubsan
          - name: linux-x64-tsan
            os: ubuntu-latest
            shard: func-tsan
            build_args: --sanitizer=tsan
          - name: linux-arm64-asan
            os: ubuntu-24.04-arm
            shard: func-asan
            build_args: --sanitizer=asan
          - name: linux-arm64-ubsan
            os: ubuntu-24.04-arm
            shard: func-ubsan
            build_args: --sanitizer=ubsan
          - name: linux-arm64-tsan
            os: ubuntu-24.04-arm
            shard: func-tsan
            build_args: --sanitizer=tsan
          - name: macos-arm64-asan
            os: macos-latest
            shard: func-asan
            build_args: --sanitizer=asan
            test_jobs: 2
          - name: macos-arm64-ubsan
            os: macos-latest
            shard: func-ubsan
            build_args: --sanitizer=ubsan
          - name: macos-arm64-tsan
            os: macos-latest
            shard: func-tsan
            build_args: --sanitizer=tsan
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Build
        run: |
          BUILD_ARGS="${{ matrix.build_args }}"
          if [[ "${GITHUB_REF_NAME:-}" == v* ]]; then
            BUILD_ARGS="$BUILD_ARGS -DENVY_VERSION=${GITHUB_REF_NAME#v}"
          fi
          ./build.sh $BUILD_ARGS

      - name: Smoke test
        if: matrix.shard == 'main'
        run: ls -al out/build/envy && ./out/build/envy -v

      - name: Functional tests
        if: startsWith(matrix.shard, 'func-')
        run: python3.13 -m functional_tests
        env:
          ENVY_TEST_JOBS: ${{ matrix.test_jobs || '2' }}

      - name: Upload envy artifact
        uses: actions/upload-artifact@v4
        with:
          name: envy-${{ matrix.name }}
          path: out/build/envy
          retention-days: 90

  build-windows:
    name: ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: windows-x64-main
            shard: main
            build_args: --no-functional-tester
          - name: windows-x64-func
            shard: func-main
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Build
        shell: powershell
        run: |
          &"C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\Launch-VsDevShell.ps1" -Arch amd64 -HostArch amd64
          $BuildArgs = "${{ matrix.build_args }}"
          $Arguments = @()
          if (-not [string]::IsNullOrWhiteSpace($BuildArgs)) {
            $Arguments += $BuildArgs -split '\s+'
          }
          if ($env:GITHUB_REF_NAME -match '^v') {
            $Version = $env:GITHUB_REF_NAME -replace '^v', ''
            $Arguments += "-DENVY_VERSION=$Version"
          }
          & ./build.bat @Arguments

      - name: Smoke test
        if: matrix.shard == 'main'
        shell: cmd
        run: |
          dir out\build\envy.exe
          out\build\envy.exe -v

      - name: Functional tests
        if: startsWith(matrix.shard, 'func-')
        run: py -3.13 -m functional_tests
        env:
          ENVY_TEST_JOBS: ${{ matrix.test_jobs || '2' }}

      - name: Upload envy artifact
        uses: actions/upload-artifact@v4
        with:
          name: envy-${{ matrix.name }}
          path: out\build\envy.exe
          retention-days: 90
