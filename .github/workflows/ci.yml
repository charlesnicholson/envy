name: ci

on:
  workflow_call:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Main shards (build envy + unit tests)
          - os: ubuntu-latest
            shard: main
            build_args: --no-functional-tester
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-linux-x86_64.tar.gz
          - os: ubuntu-24.04-arm
            shard: main
            build_args: --no-functional-tester
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-linux-aarch64.tar.gz
          - os: macos-latest
            shard: main
            build_args: --no-functional-tester
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-macos-universal.tar.gz
          # Functional test shards - Linux x64
          - os: ubuntu-latest
            shard: func-asan
            build_args: --sanitizer=asan
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-linux-x86_64.tar.gz
          - os: ubuntu-latest
            shard: func-ubsan
            build_args: --sanitizer=ubsan
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-linux-x86_64.tar.gz
          - os: ubuntu-latest
            shard: func-tsan
            build_args: --sanitizer=tsan
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-linux-x86_64.tar.gz
          # Functional test shards - Linux arm64
          - os: ubuntu-24.04-arm
            shard: func-asan
            build_args: --sanitizer=asan
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-linux-aarch64.tar.gz
          - os: ubuntu-24.04-arm
            shard: func-ubsan
            build_args: --sanitizer=ubsan
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-linux-aarch64.tar.gz
          - os: ubuntu-24.04-arm
            shard: func-tsan
            build_args: --sanitizer=tsan
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-linux-aarch64.tar.gz
          # Functional test shards - macOS
          - os: macos-latest
            shard: func-asan
            build_args: --sanitizer=asan
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-macos-universal.tar.gz
          - os: macos-latest
            shard: func-ubsan
            build_args: --sanitizer=ubsan
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-macos-universal.tar.gz
          - os: macos-latest
            shard: func-tsan
            build_args: --sanitizer=tsan
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-macos-universal.tar.gz
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Setup cmake
        run: |
          echo "Downloading from: ${{ matrix.cmake_url }}"
          mkdir cmake && curl -fsSL "${{ matrix.cmake_url }}" | tar -xzf - -C cmake --strip-components=1
          echo "Contents of cmake dir:"
          ls -la cmake/
          echo "Contents of cmake/bin:"
          ls -la cmake/bin/
          echo "cmake version:"
          cmake/bin/cmake --version
          echo "$PWD/cmake/bin" >> $GITHUB_PATH

      - name: Verify cmake in PATH
        run: |
          echo "PATH: $PATH"
          which cmake
          cmake --version

      - uses: actions/checkout@v5

      - name: Build
        run: |
          echo "cmake in build step:"
          which cmake
          cmake --version
          ./build.sh ${{ matrix.build_args }}

      - name: Smoke test
        if: matrix.shard == 'main'
        run: ls -al out/build/envy && ./out/build/envy -v

      - name: Functional tests
        if: startsWith(matrix.shard, 'func-')
        run: python3.13 -m functional_tests

  build-windows:
    strategy:
      fail-fast: false
      matrix:
        include:
          - shard: main
            build_args: --no-functional-tester
          - shard: func-asan
            build_args: --sanitizer=asan
    runs-on: windows-latest
    steps:
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Setup cmake
        shell: pwsh
        run: |
          echo "Downloading cmake..."
          curl -fsSL -o cmake.zip "https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-windows-x86_64.zip"
          echo "Extracting..."
          Expand-Archive -Path cmake.zip -DestinationPath cmake-tmp
          echo "Contents of cmake-tmp:"
          Get-ChildItem cmake-tmp
          Move-Item cmake-tmp/cmake-* cmake
          echo "Contents of cmake:"
          Get-ChildItem cmake
          echo "Contents of cmake/bin:"
          Get-ChildItem cmake/bin
          echo "cmake version:"
          ./cmake/bin/cmake.exe --version
          echo "$PWD/cmake/bin" >> $env:GITHUB_PATH

      - name: Verify cmake in PATH
        shell: pwsh
        run: |
          echo "PATH: $env:PATH"
          Get-Command cmake
          cmake --version

      - uses: actions/checkout@v5

      - name: Build
        shell: powershell
        run: |
          echo "cmake in build step:"
          Get-Command cmake
          cmake --version
          &"C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\Launch-VsDevShell.ps1" -Arch amd64 -HostArch amd64
          ./build.bat ${{ matrix.build_args }}

      - name: Smoke test
        if: matrix.shard == 'main'
        shell: cmd
        run: |
          dir out\build\envy.exe
          out\build\envy.exe -v

      - name: Functional tests
        if: startsWith(matrix.shard, 'func-')
        run: python3.13 -m functional_tests
