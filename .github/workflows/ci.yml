name: ci

on:
  workflow_call:

jobs:
  build:
    name: ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x64-main
            os: ubuntu-latest
            shard: main
            build_args: --no-functional-tester
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-linux-x86_64.tar.gz
          - name: linux-arm64-main
            os: ubuntu-24.04-arm
            shard: main
            build_args: --no-functional-tester
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-linux-aarch64.tar.gz
          - name: macos-arm64-main
            os: macos-latest
            shard: main
            build_args: --no-functional-tester
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-macos-universal.tar.gz
          - name: linux-x64-asan
            os: ubuntu-latest
            shard: func-asan
            build_args: --sanitizer=asan
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-linux-x86_64.tar.gz
          - name: linux-x64-ubsan
            os: ubuntu-latest
            shard: func-ubsan
            build_args: --sanitizer=ubsan
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-linux-x86_64.tar.gz
          - name: linux-x64-tsan
            os: ubuntu-latest
            shard: func-tsan
            build_args: --sanitizer=tsan
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-linux-x86_64.tar.gz
          - name: linux-arm64-asan
            os: ubuntu-24.04-arm
            shard: func-asan
            build_args: --sanitizer=asan
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-linux-aarch64.tar.gz
          - name: linux-arm64-ubsan
            os: ubuntu-24.04-arm
            shard: func-ubsan
            build_args: --sanitizer=ubsan
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-linux-aarch64.tar.gz
          - name: linux-arm64-tsan
            os: ubuntu-24.04-arm
            shard: func-tsan
            build_args: --sanitizer=tsan
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-linux-aarch64.tar.gz
          - name: macos-arm64-asan
            os: macos-latest
            shard: func-asan
            build_args: --sanitizer=asan
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-macos-universal.tar.gz
            test_jobs: 2
          - name: macos-arm64-ubsan
            os: macos-latest
            shard: func-ubsan
            build_args: --sanitizer=ubsan
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-macos-universal.tar.gz
          - name: macos-arm64-tsan
            os: macos-latest
            shard: func-tsan
            build_args: --sanitizer=tsan
            cmake_url: https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-macos-universal.tar.gz
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Setup cmake
        run: |
          mkdir -p out/cmake && curl -fsSL "${{ matrix.cmake_url }}" | tar -xzf - -C out/cmake --strip-components=1

      - name: Build
        run: |
          export PATH="$PWD/out/cmake/bin:$PATH"
          VERSION_ARG=""
          if [[ "${GITHUB_REF_NAME:-}" == v* ]]; then
            VERSION_ARG="-DENVY_VERSION=${GITHUB_REF_NAME#v}"
          fi
          ./build.sh ${{ matrix.build_args }} $VERSION_ARG

      - name: Smoke test
        if: matrix.shard == 'main'
        run: ls -al out/build/envy && ./out/build/envy -v

      - name: Functional tests
        if: startsWith(matrix.shard, 'func-')
        run: python3.13 -m functional_tests
        env:
          ENVY_TEST_JOBS: ${{ matrix.test_jobs || '' }}

      - name: Upload envy artifact
        uses: actions/upload-artifact@v4
        with:
          name: envy-${{ matrix.name }}
          path: out/build/envy
          retention-days: 90

  build-windows:
    name: ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: windows-x64-main
            shard: main
            build_args: --no-functional-tester
          - name: windows-x64-func
            shard: func-main
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Setup cmake
        shell: pwsh
        run: |
          curl -fsSL -o cmake.zip "https://github.com/Kitware/CMake/releases/download/v4.1.2/cmake-4.1.2-windows-x86_64.zip"
          Expand-Archive -Path cmake.zip -DestinationPath out
          Move-Item out/cmake-* out/cmake

      - name: Build
        shell: powershell
        run: |
          $env:PATH = "$PWD\out\cmake\bin;$env:PATH"
          &"C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\Launch-VsDevShell.ps1" -Arch amd64 -HostArch amd64
          $VersionArg = ""
          if ($env:GITHUB_REF_NAME -match '^v') {
            $Version = $env:GITHUB_REF_NAME -replace '^v', ''
            $VersionArg = "-DENVY_VERSION=$Version"
          }
          ./build.bat ${{ matrix.build_args }} $VersionArg

      - name: Smoke test
        if: matrix.shard == 'main'
        shell: cmd
        run: |
          dir out\build\envy.exe
          out\build\envy.exe -v

      - name: Functional tests
        if: startsWith(matrix.shard, 'func-')
        run: py -3.13 -m functional_tests

      - name: Upload envy artifact
        uses: actions/upload-artifact@v4
        with:
          name: envy-${{ matrix.name }}
          path: out\build\envy.exe
          retention-days: 90
