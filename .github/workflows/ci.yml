name: ci

on:
  workflow_call:

jobs:
  build:
    name: ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x64-main
            os: ubuntu-latest
            shard: main
            build_args: --no-functional-tester
          - name: linux-arm64-main
            os: ubuntu-24.04-arm
            shard: main
            build_args: --no-functional-tester
          - name: macos-arm64-main
            os: macos-latest
            shard: main
            build_args: --no-functional-tester
          - name: macos-arm64-func
            os: macos-latest
            shard: func-main
          - name: macos-x64-main
            os: macos-15-intel
            shard: main
            build_args: --no-functional-tester
          - name: macos-x64-func
            os: macos-15-intel
            shard: func-main
          - name: linux-x64-asan
            os: ubuntu-latest
            shard: func-asan
            build_args: --sanitizer=asan
          - name: linux-x64-ubsan
            os: ubuntu-latest
            shard: func-ubsan
            build_args: --sanitizer=ubsan
          - name: linux-x64-tsan
            os: ubuntu-latest
            shard: func-tsan
            build_args: --sanitizer=tsan
          - name: linux-arm64-asan
            os: ubuntu-24.04-arm
            shard: func-asan
            build_args: --sanitizer=asan
          - name: linux-arm64-ubsan
            os: ubuntu-24.04-arm
            shard: func-ubsan
            build_args: --sanitizer=ubsan
          - name: linux-arm64-tsan
            os: ubuntu-24.04-arm
            shard: func-tsan
            build_args: --sanitizer=tsan
          - name: linux-x64-valgrind
            os: ubuntu-latest
            shard: func-valgrind
            test_jobs: 1
            test_timeout: 300
          - name: linux-arm64-valgrind
            os: ubuntu-24.04-arm
            shard: func-valgrind
            test_jobs: 1
            test_timeout: 300
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Cache third-party downloads
        uses: actions/cache@v4
        with:
          path: out/cache
          key: ${{ runner.os }}-${{ runner.arch }}-deps-${{ hashFiles('cmake/Dependencies.cmake', 'cmake/deps/*.cmake', 'cmake/templates/*', 'tools/build.py') }}

      - name: Install test dependencies
        if: startsWith(matrix.shard, 'func-')
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update -qq && sudo apt-get install -y -qq zsh fish valgrind
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            brew install fish
          fi

      - name: Build
        run: |
          BUILD_ARGS="${{ matrix.build_args }}"
          if [[ "${GITHUB_REF_NAME:-}" == v* ]]; then
            BUILD_ARGS="$BUILD_ARGS -DENVY_VERSION=${GITHUB_REF_NAME#v}"
          fi
          ./build.sh $BUILD_ARGS

      - name: Smoke test
        if: matrix.shard == 'main'
        run: ls -al out/build/envy && ./out/build/envy -v

      - name: Install valgrind
        if: matrix.shard == 'main' && runner.os == 'Linux'
        run: sudo apt-get update -qq && sudo apt-get install -y -qq valgrind

      - name: Unit tests under valgrind
        if: matrix.shard == 'main' && runner.os == 'Linux'
        run: valgrind -q --error-exitcode=1 --leak-check=full --suppressions=valgrind.supp out/build/envy_unit_tests

      - name: Functional tests
        if: startsWith(matrix.shard, 'func-')
        run: python3.13 -m functional_tests
        env:
          ENVY_TEST_JOBS: ${{ matrix.test_jobs || '2' }}
          ENVY_TEST_TIMEOUT: ${{ matrix.test_timeout || '60' }}
          ENVY_TEST_WRAPPER: ${{ matrix.shard == 'func-valgrind' && format('valgrind -q --error-exitcode=1 --leak-check=full --suppressions={0}/valgrind.supp', github.workspace) || '' }}

      - name: Upload envy artifact
        uses: actions/upload-artifact@v4
        with:
          name: envy-${{ matrix.name }}
          path: out/build/envy
          retention-days: 90

  build-windows:
    name: ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: windows-x64-main
            os: windows-latest
            arch: amd64
            shard: main
            build_args: --no-functional-tester
          - name: windows-x64-func
            os: windows-latest
            arch: amd64
            shard: func-main
          - name: windows-arm64-main
            os: windows-11-arm
            arch: arm64
            shard: main
            build_args: --no-functional-tester
          - name: windows-arm64-func
            os: windows-11-arm
            arch: arm64
            shard: func-main
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Cache third-party downloads
        uses: actions/cache@v4
        with:
          path: out/cache
          key: ${{ runner.os }}-${{ runner.arch }}-deps-${{ hashFiles('cmake/Dependencies.cmake', 'cmake/deps/*.cmake', 'cmake/templates/*', 'tools/build.py') }}

      - name: Build
        shell: powershell
        run: |
          &"C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\Launch-VsDevShell.ps1" -Arch ${{ matrix.arch }} -HostArch amd64
          $BuildArgs = "${{ matrix.build_args }}"
          $Arguments = @()
          if (-not [string]::IsNullOrWhiteSpace($BuildArgs)) {
            $Arguments += $BuildArgs -split '\s+'
          }
          if ($env:GITHUB_REF_NAME -match '^v') {
            $Version = $env:GITHUB_REF_NAME -replace '^v', ''
            $Arguments += "-DENVY_VERSION=$Version"
          }
          & ./build.bat @Arguments

      - name: Smoke test
        if: matrix.shard == 'main'
        shell: cmd
        run: |
          dir out\build\envy.exe
          out\build\envy.exe -v

      - name: Functional tests
        if: startsWith(matrix.shard, 'func-')
        run: py -3.13 -m functional_tests
        env:
          ENVY_TEST_JOBS: ${{ matrix.test_jobs || '2' }}

      - name: Upload envy artifact
        uses: actions/upload-artifact@v4
        with:
          name: envy-${{ matrix.name }}
          path: out\build\envy.exe
          retention-days: 90
