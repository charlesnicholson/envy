import pathlib

# AWS CRT's top-level CMake hard-wires an aws_prebuild_dependency() call for
# aws-lc, which configures and builds libcrypto during the configure phase.
# That violates Envy's "configure-everything before building anything"
# contract and forces every reconfigure to relink libcrypto. Replace that
# block with a standard add_subdirectory() flow that pins the same feature
# toggles and reapplies the warning relaxations after the target exists.

awscrt_cmakelists = pathlib.Path(r"@AWSCRT_CMAKELISTS@")
text = awscrt_cmakelists.read_text()

marker = "# envy: disable aws crt prebuild"

old_block = """        if(NOT USE_OPENSSL)
            include(AwsPrebuildDependency)

            if(ENFORCE_SUBMODULE_VERSIONS)
                check_submodule_commit("aws-lc" "crt/aws-lc")
            endif()

            set(AWSLC_CMAKE_C_FLAGS "${CMAKE_C_FLAGS}")

            # temporarily disable certain warnings as errors for the aws-lc build
            if(NOT MSVC)
                check_c_compiler_flag(-Wno-stringop-overflow HAS_WNO_STRINGOP_OVERFLOW)

                if(HAS_WNO_STRINGOP_OVERFLOW)
                    set(AWSLC_CMAKE_C_FLAGS "${AWSLC_CMAKE_C_FLAGS} -Wno-stringop-overflow")
                endif()

                check_c_compiler_flag(-Wno-array-parameter HAS_WNO_ARRAY_PARAMETER)

                if(HAS_WNO_ARRAY_PARAMETER)
                    set(AWSLC_CMAKE_C_FLAGS "${AWSLC_CMAKE_C_FLAGS} -Wno-array-parameter")
                endif()
            endif()

            # s2n-tls uses libcrypto during its configuration, so we need to prebuild aws-lc.
            aws_prebuild_dependency(
                DEPENDENCY_NAME AWSLC
                SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/crt/aws-lc
                CMAKE_ARGUMENTS
                    -DDISABLE_GO=ON
                    -DDISABLE_PERL=ON
                    -DBUILD_LIBSSL=OFF
                    -DBUILD_TESTING=OFF
                    -DCMAKE_C_FLAGS=${AWSLC_CMAKE_C_FLAGS}
            )
        endif()
"""

replacement = """        if(NOT USE_OPENSSL)
            if(ENFORCE_SUBMODULE_VERSIONS)
                check_submodule_commit("aws-lc" "crt/aws-lc")
            endif()

            set(DISABLE_GO ON CACHE BOOL "" FORCE)
            set(DISABLE_PERL ON CACHE BOOL "" FORCE)
            set(BUILD_LIBSSL OFF CACHE BOOL "" FORCE)
            set(BUILD_TESTING OFF CACHE BOOL "" FORCE)

            set(_ENVY_AWSLC_WARNING_FLAGS "")

            if(NOT MSVC)
                check_c_compiler_flag(-Wno-stringop-overflow HAS_WNO_STRINGOP_OVERFLOW)

                if(HAS_WNO_STRINGOP_OVERFLOW)
                    list(APPEND _ENVY_AWSLC_WARNING_FLAGS -Wno-stringop-overflow)
                endif()

                check_c_compiler_flag(-Wno-array-parameter HAS_WNO_ARRAY_PARAMETER)

                if(HAS_WNO_ARRAY_PARAMETER)
                    list(APPEND _ENVY_AWSLC_WARNING_FLAGS -Wno-array-parameter)
                endif()
            endif()

            add_subdirectory(crt/aws-lc) # envy: disable aws crt prebuild

            if(TARGET crypto AND _ENVY_AWSLC_WARNING_FLAGS)
                target_compile_options(crypto PRIVATE ${_ENVY_AWSLC_WARNING_FLAGS})
            endif()
            unset(_ENVY_AWSLC_WARNING_FLAGS)
        endif()
"""

if old_block not in text:
    if marker in text:
        raise SystemExit(0)
    raise RuntimeError("Original AWS prebuild block not found")

text = text.replace(old_block, replacement, 1)
awscrt_cmakelists.write_text(text)
