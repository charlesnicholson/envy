import pathlib
import re

# Remove -Wa,--noexecstack from aws-lc and s2n assembly builds to silence
# lto-wrapper warnings during TSAN+LTO linking. The flag is unnecessaryâ€”
# GNU linker marks stacks non-executable by default on modern Linux.

aws_lc_crypto_cmakelists = pathlib.Path(r"@AWS_LC_CRYPTO_CMAKELISTS@")
s2n_cmakelists = pathlib.Path(r"@S2N_CMAKELISTS@")

# Patch aws-lc crypto/CMakeLists.txt
text = aws_lc_crypto_cmakelists.read_text()
marker = "# envy: removed -Wa,--noexecstack"

if marker not in text:
    # Replace CMAKE_ASM_FLAGS line containing -Wa,--noexecstack
    pattern = re.compile(
        r'(\s+set\(CMAKE_ASM_FLAGS\s+"[^"]*)-Wa,--noexecstack([^"]*"\))',
        re.MULTILINE
    )
    match = pattern.search(text)
    if match:
        text = pattern.sub(r'\1\2 ' + marker, text)
        aws_lc_crypto_cmakelists.write_text(text)
    else:
        raise RuntimeError("aws-lc: CMAKE_ASM_FLAGS with -Wa,--noexecstack not found")

# Patch s2n CMakeLists.txt
text = s2n_cmakelists.read_text()
mbranches_marker = "# envy: removed -Wa,-mbranches-within-32B-boundaries"

if marker not in text:
    # Remove the line containing -Wa,--noexecstack from compile options list
    pattern = re.compile(
        r'\s+# Assembler Options\n\s+-Wa,--noexecstack\n',
        re.MULTILINE
    )
    match = pattern.search(text)
    if match:
        text = pattern.sub('\n    ' + marker + '\n', text)
        s2n_cmakelists.write_text(text)
    else:
        raise RuntimeError("s2n: -Wa,--noexecstack compile option not found")

# Also remove -Wa,-mbranches-within-32B-boundaries from s2n
text = s2n_cmakelists.read_text()
if mbranches_marker not in text:
    # Remove target_compile_options line with -Wa,-mbranches-within-32B-boundaries
    pattern = re.compile(
        r'if \(S2N_COMPILER_SUPPORTS_BRANCH_ALIGN AND NOT S2N_FUZZ_TEST\)\n'
        r'\s+target_compile_options\(\$\{PROJECT_NAME\} PRIVATE "-Wa,-mbranches-within-32B-boundaries"\)\n'
        r'endif\(\)',
        re.MULTILINE
    )
    match = pattern.search(text)
    if match:
        text = pattern.sub(mbranches_marker, text)
        s2n_cmakelists.write_text(text)
    else:
        # Try without strict newline matching
        pattern2 = re.compile(
            r'target_compile_options\(\$\{PROJECT_NAME\} PRIVATE "-Wa,-mbranches-within-32B-boundaries"\)',
            re.MULTILINE
        )
        match2 = pattern2.search(text)
        if match2:
            text = pattern2.sub(mbranches_marker, text)
            s2n_cmakelists.write_text(text)
        # else: silently skip if not found (may not be present in all versions)
