import pathlib

# AWS SDK's curl capability probe runs a try-compile that links against the
# value of CMAKE_REQUIRED_LIBRARIES. When Envy supplies libcurl via
# FetchContent the variable expands to a generator expression referencing the
# in-tree static target, which makes the probe crash because the scratch
# project cannot resolve build-tree targets. Inject an intermediate branch
# that falls back to compile-only detection whenever the value looks like a
# generator expression, keeping the runtime check for system-installed curl.

core_cmakelists = pathlib.Path(r"@AWS_CORE_CMAKELISTS@")
text = core_cmakelists.read_text()

marker = "envy override curl probe"
if marker not in text:
    set_line = "    set(CMAKE_REQUIRED_LIBRARIES ${curl_lib})\n"
    set_replacement = """\
    if("${curl_lib}" MATCHES "^\\\\$<TARGET_FILE:[^>]+>$") # envy override curl libs
        set(CMAKE_REQUIRED_LIBRARIES "")
    else()
        set(CMAKE_REQUIRED_LIBRARIES ${curl_lib})
    endif()
"""
    if set_line not in text:
        raise RuntimeError("AWS SDK curl required-libraries assignment not found")
    text = text.replace(set_line, set_replacement, 1)

    snippet = """\
    if (CMAKE_CROSSCOMPILING)
        check_c_source_compiles("${CHECK_CURL_HAS_H2}" CURL_HAS_H2)
        check_c_source_compiles("${CHECK_CURL_HAS_TLS_PROXY}" CURL_HAS_TLS_PROXY)
    else()
        check_c_source_runs("${CHECK_CURL_HAS_H2}" CURL_HAS_H2)
        check_c_source_runs("${CHECK_CURL_HAS_TLS_PROXY}" CURL_HAS_TLS_PROXY)
    endif()
"""
    replacement = """\
    if (CMAKE_CROSSCOMPILING)
        check_c_source_compiles("${CHECK_CURL_HAS_H2}" CURL_HAS_H2)
        check_c_source_compiles("${CHECK_CURL_HAS_TLS_PROXY}" CURL_HAS_TLS_PROXY)
    elseif("${curl_lib}" MATCHES "^\\\\$<TARGET_FILE:[^>]+>$") # envy override curl probe
        check_c_source_compiles("${CHECK_CURL_HAS_H2}" CURL_HAS_H2)
        check_c_source_compiles("${CHECK_CURL_HAS_TLS_PROXY}" CURL_HAS_TLS_PROXY)
    else()
        check_c_source_runs("${CHECK_CURL_HAS_H2}" CURL_HAS_H2)
        check_c_source_runs("${CHECK_CURL_HAS_TLS_PROXY}" CURL_HAS_TLS_PROXY)
    endif()
"""
    if snippet not in text:
        raise RuntimeError("AWS SDK curl probe snippet not found")
    text = text.replace(snippet, replacement)
    core_cmakelists.write_text(text)
