import pathlib

# Patch libgit2's DefaultCFlags.cmake to use /O1 (minimize size) instead of
# /O2 (maximize speed) in Release builds.  libgit2 unconditionally overwrites
# CMAKE_C_FLAGS_RELEASE, discarding Envy's global size-optimization setting.

path = pathlib.Path(r"@LIBGIT2_DEFAULT_CFLAGS@")
text = path.read_text()

old = 'set(CMAKE_C_FLAGS_RELEASE "/DNDEBUG /O2 /Oy /GL /Gy ${CRT_FLAG_RELEASE}")'
new = 'set(CMAKE_C_FLAGS_RELEASE "/DNDEBUG /O1 /Oy /GL /Gy ${CRT_FLAG_RELEASE}")'

if new in text:
    pass  # already patched (cached source tree)
elif old in text:
    path.write_text(text.replace(old, new))
else:
    raise SystemExit("libgit2 DefaultCFlags.cmake: neither /O2 nor /O1 Release line found")
