import pathlib
import re

# Upstream libgit2 insists on discovering libssh2 through pkg-config even when
# we vend the library via FetchContent. This patch short-circuits SelectSSH to
# consume the in-tree libssh2 target when it exists, preserving our include
# paths and avoiding redundant pkg-config lookups.

select_path = pathlib.Path(r"@SELECT_PATH@")
text = select_path.read_text()

if "envy override v2" not in text:
    updated = text.replace(
        "find_pkglibraries(LIBSSH2 libssh2)\n",
        "if(TARGET libssh2::libssh2) # envy override v2\n"
        "\tset(LIBSSH2_FOUND 1)\n"
        "\tset(LIBSSH2_INCLUDE_DIRS \"@LIBSSH2_SOURCE@/include\")\n"
        "\tset(LIBSSH2_LIBRARY_DIRS \"@LIBSSH2_BINARY@/src\")\n"
        "\tset(LIBSSH2_LIBRARIES \"@LIBSSH2_BINARY@/src/libssh2.a\")\n"
        "\tset(LIBSSH2_LDFLAGS \"\")\n"
        "else()\n"
        "\tfind_pkglibraries(LIBSSH2 libssh2)\n"
        "endif()\n",
    )

    updated = re.sub(
        r"\tcheck_library_exists\(\"\${LIBSSH2_LIBRARIES}\" libssh2_userauth_publickey_frommemory \"\${LIBSSH2_LIBRARY_DIRS}\" HAVE_LIBSSH2_MEMORY_CREDENTIALS\)\n"
        r"\tif\(HAVE_LIBSSH2_MEMORY_CREDENTIALS\)\n"
        r"\t\tset\(GIT_SSH_MEMORY_CREDENTIALS 1\)\n"
        r"\tendif\(\)\n",
        "if(NOT TARGET libssh2::libssh2) # envy override v2\n"
        "\tcheck_library_exists(\"@LIBSSH2_BINARY@/src/libssh2.a\" libssh2_userauth_publickey_frommemory \"@LIBSSH2_BINARY@/src\" HAVE_LIBSSH2_MEMORY_CREDENTIALS)\n"
        "\tif(HAVE_LIBSSH2_MEMORY_CREDENTIALS)\n"
        "\t\tset(GIT_SSH_MEMORY_CREDENTIALS 1)\n"
        "\tendif()\n"
        "else()\n"
        "\tset(GIT_SSH_MEMORY_CREDENTIALS 1)\n"
        "endif()\n",
        updated,
        count=1,
    )

    select_path.write_text(updated)
