#!/usr/bin/env python3
"""Unicode-aware unzip shim using Python's zipfile module.

This script intentionally supports the limited flag set used by
AWS's prefetch_crt_dependency.sh: `-d` for the destination directory,
optional `-o` to overwrite (silently accepted), and quiet flags `-q`/`-qq`.
All other flags result in an error so unexpected usage surfaces quickly.
"""
import os
import sys
import zipfile
from typing import List


def _resolve_archive(path: str) -> str:
    """Return a filesystem path to the archive, allowing implicit `.zip`"""
    if os.path.isfile(path):
        return path
    candidate = f"{path}.zip"
    if os.path.isfile(candidate):
        return candidate
    raise FileNotFoundError(path)


def _extract(archive: str, dest: str, quiet: bool) -> None:
    # zipfile obeys UTF-8 file names and handles creating directories.
    with zipfile.ZipFile(archive, "r") as zf:
        # Ensure destination exists before extraction.
        os.makedirs(dest, exist_ok=True)
        for member in zf.infolist():
            if not quiet:
                sys.stdout.write(f"  inflating: {member.filename}\n")
            zf.extract(member, path=dest)


def main(argv: List[str]) -> int:
    dest = os.curdir
    quiet = False
    archive = None
    i = 0
    argc = len(argv)
    while i < argc:
        arg = argv[i]
        if arg in ("-o", "-n"):  # Overwrite/never overwrite: handled implicitly
            i += 1
            continue
        if arg in ("-q", "-qq"):
            quiet = True
            i += 1
            continue
        if arg == "-d":
            if i + 1 >= argc:
                sys.stderr.write("unzip shim: `-d` requires a parameter\n")
                return 1
            dest = argv[i + 1]
            i += 2
            continue
        if arg.startswith("-"):
            sys.stderr.write(f"unzip shim: unsupported option {arg}\n")
            return 1
        if archive is None:
            archive = arg
        else:
            # Basic unzip allows additional file filters after the archive.
            # This shim does not implement selective extraction yet; reject.
            sys.stderr.write("unzip shim: file filters are not supported\n")
            return 1
        i += 1

    if archive is None:
        sys.stderr.write("unzip shim: no archive specified\n")
        return 1

    try:
        resolved = _resolve_archive(archive)
    except FileNotFoundError:
        sys.stderr.write(f"unzip shim: archive not found: {archive}\n")
        return 1

    try:
        _extract(resolved, dest, quiet)
    except zipfile.BadZipFile as exc:
        sys.stderr.write(f"unzip shim: bad zip file: {exc}\n")
        return 1
    except Exception as exc:
        sys.stderr.write(f"unzip shim: {exc}\n")
        return 1

    return 0


if __name__ == "__main__":
    sys.exit(main(sys.argv[1:]))
